@model MovieDataBase.Models.Movies

<h1 class="mb-4 text-light">@Model.Title</h1>


@if (Model.Images != null && Model.Images.Any())
{
    <div id="movieCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            @for (int i = 0; i < Model.Images.Count; i++)
            {
                var img = Model.Images[i];
                <div class="carousel-item @(i == 0 ? "active" : "")">
                    <img src="@img.FullUrl"
                         class="d-block w-100"
                         alt="@Model.Title"
                         style="max-height:500px; object-fit:contain; background-color:black;" />
                </div>
            }
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#movieCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#movieCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>
}
else
{
    <p class="text-muted"><em>No images available.</em></p>
}

<div class="mb-4 bg-dark p-4 rounded border border-secondary">
    <h4 class="text-light">Movie Details</h4>
    <dl class="row text-light">
        <dt class="col-sm-3">Director</dt>
        <dd class="col-sm-9">
            @{
                var directorPeople = Model.PeopleRoles?
                    .Where(pr => pr.Role != null && pr.Role.Id == 1)
                    .Select(pr => pr.People)
                    .Where(p => p != null)
                    .ToList() ?? new List<MovieDataBase.Models.People>();

                var writerPeople = Model.PeopleRoles?
                    .Where(pr => pr.Role != null && pr.Role.Id == 3)
                    .Select(pr => pr.People)
                    .Where(p => p != null)
                    .ToList() ?? new List<MovieDataBase.Models.People>();

                var producerPeople = Model.PeopleRoles?
                    .Where(pr => pr.Role != null && pr.Role.Id == 4)
                    .Select(pr => pr.People)
                    .Where(p => p != null)
                    .ToList() ?? new List<MovieDataBase.Models.People>();

            }

            @* Directors (people links, comma separated). If none, fallback to Model.Director string. *@
            @if (directorPeople.Any())
            {
                for (int i = 0; i < directorPeople.Count; i++)
                {
                    var person = directorPeople[i];
                    if (i > 0)
                    {
                        @:<span class="text-light">, </span>
                    }
                    <a asp-controller="People" asp-action="Details" asp-route-id="@person!.Id" class="people-link">@person!.Name</a>
                }

            }
            else
            {
                <em class="text-muted">Unknown</em>
            }
        </dd>

        @* Writer (only shown if there are writer records) *@
        @if (writerPeople.Any())
        {
            <dt class="col-sm-3">Writer</dt>
            <dd class="col-sm-9">
                @for (int i = 0; i < writerPeople.Count; i++)
                {
                    var person = writerPeople[i];
                    if (i > 0)
                    {
                        @:<span class="text-light">, </span>
                    }
                    <a asp-controller="People" asp-action="Details" asp-route-id="@person!.Id" class="people-link">@person!.Name</a>
                }
            </dd>
        }

        @* Producer (only shown if there are producer records) *@
        @if (producerPeople.Any())
        {
            <dt class="col-sm-3">Producer</dt>
            <dd class="col-sm-9">
                @for (int i = 0; i < producerPeople.Count; i++)
                {
                    var person = producerPeople[i];
                    if (i > 0)
                    {
                        @:<span class="text-light">, </span>
                    }
                    <a asp-controller="People" asp-action="Details" asp-route-id="@person!.Id" class="people-link">@person!.Name</a>
                }
            </dd>
        }

        <dt class="col-sm-3">Release Date</dt>
        <dd class="col-sm-9">@Model.DateReleased?.ToString("dd-MM-yyyy")</dd>

        <dt class="col-sm-3">Description</dt>
        <dd class="col-sm-9">@Model.Description</dd>

        <dt class="col-sm-3">Runtime</dt>
        <dd class="col-sm-9">
            @if (Model.Runtime.HasValue)
            {
                @($"{Model.Runtime.Value} min")
            }
            else
            {
                <em>Unknown</em>
            }
        </dd>

        <dt class="col-sm-3">Content Rating</dt>
        <dd class="col-sm-9">
            @if (!string.IsNullOrWhiteSpace(Model.ContentRating))
            {
                @Model.ContentRating
            }
            else
            {
                <em>Not set</em>
            }
        </dd>

        <dt class="col-sm-3">Critique Score</dt>
        <dd class="col-sm-9">
            @if (Model.CritiqueScore.HasValue)
            {
                <span class="badge bg-success">@Model.CritiqueScore.Value/100</span>
            }
            else
            {
                <em>Not rated</em>
            }
        </dd>

        <dt class="col-sm-3">Genres</dt>
        <dd class="col-sm-9">
            @if (Model.MovieGenres != null && Model.MovieGenres.Any(mg => mg.Genre != null))
            {
                @string.Join(", ", Model.MovieGenres.Where(mg => mg.Genre != null).Select(mg => mg.Genre.Name))
            }
            else
            {
                <em>No genres assigned</em>
            }
        </dd>
        <hr>
        <dt class="col-sm-3">Cast</dt>
        <dd class="col-sm-9">
            @if (Model.PeopleRoles != null && Model.PeopleRoles.Any())
            {
                var castList = Model.PeopleRoles
                    .Where(pr => pr.RoleId == 2)
                    .ToList();

                @if (castList.Any())
                {
                    <div class="row">
                        @foreach (var pr in castList)
                        {
                            var person = pr.People;
                            var profileUrl = "/images/no-profile.svg";
                            <div class="col-12 col-md-6 mb-3">
                                <div class="d-flex align-items-center p-2 bg-dark rounded border border-secondary">
                                    <img src="@profileUrl"
                                         alt="NA"
                                         class="rounded-circle me-3"
                                         style="width:64px;height:64px;object-fit:cover;border:2px solid #6c757d;" />
                                    <div class="text-light">
                                        <div class="fw-bold">
                                            @if (person != null)
                                            {
                                                <a asp-controller="People" asp-action="Details" asp-route-id="@person.Id" class="people-link">
                                                    @person.Name
                                                </a>
                                            }
                                            else
                                            {
                                                @:<span class="text-light">Unknown</span>
                                            }
                                        </div>
                                        <div class="text-secondary">@(!string.IsNullOrWhiteSpace(pr.CharacterName) ? pr.CharacterName : "<em>Character not set</em>")</div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <em>No cast assigned</em>
                }
            }
            else
            {
                <em>No cast assigned</em>
            }
        </dd>
    </dl>
</div>

<div>
    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Edit</a>
    <a asp-action="Index" class="btn btn-secondary">Back to List</a>
</div>
